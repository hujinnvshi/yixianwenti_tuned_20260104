# Excel公式功能说明

## 概述

本系统在生成的Excel报表中为AE列(研发交付日期偏差)和AO列(用于交付日期偏差统计)添加了**动态Excel公式**,方便报告查看人核对计算逻辑。

## 功能特点

✅ **动态计算** - 公式会根据单元格的实际值自动计算
✅ **易于核对** - 可以在Excel中查看完整的公式逻辑
✅ **自动更新** - 修改基础数据后,公式结果会自动重新计算
✅ **透明可见** - 在Excel中点击单元格即可看到完整公式

## 添加公式的列

### AE列 - 研发交付日期偏差

**列位置**: Sheet2(计算解决率过程数据（调整后）) 的AE列

**公式说明**:
```
=IF(处理方式<>"研发处理","非研发处理",
   IF(基准日期="","",
      实际完成日期 - 基准日期
   )
)
```

**计算逻辑**:
1. 如果处理方式 ≠ "研发处理", 返回 "非研发处理"
2. 计算基准日期:
   - 如果计划完成时间为空, 使用期望解决时间
   - 否则使用计划完成时间
3. 计算实际日期:
   - 如果研发解决时间不为空, 使用研发解决时间
   - 如果审批状态="已结束", 使用更新时间
   - 否则使用当前日期(TODAY())
4. 返回实际日期与基准日期的天数差

**Excel公式示例** (第2行):
```excel
=IF(Q2<>"研发处理","非研发处理",
   IF(IF(W2="",O2,W2)="","",
      IF(AD2="",IF(AL2="已结束",AM2,TODAY()),AD2)
      -IF(W2="",O2,W2)
   )
)
```

**列引用说明**:
- Q列: 处理方式
- O列: 期望解决时间
- W列: 计划完成时间
- AD列: 研发解决时间
- AL列: 审批状态
- AM列: 更新时间

### AO列 - 用于交付日期偏差统计

**列位置**: Sheet2(计算解决率过程数据（调整后）) 的AO列

**公式说明**:
```
=IF(AE列="非研发处理","非研发处理",
   IF(ISNUMBER(AE列),
      IF(研发解决时间<>"",
         IF(AE列<=0,"及时解决","未及时解决"),
         IF(AE列<=0,"处理中暂未超时","超时未解决")
      ),
      ""
   )
)
```

**计算逻辑**:
1. 如果AE列 = "非研发处理", 返回 "非研发处理"
2. 如果AE列是数字:
   - 如果研发解决时间不为空:
     - AE列 ≤ 0: "及时解决"
     - AE列 > 0: "未及时解决"
   - 如果研发解决时间为空:
     - AE列 ≤ 0: "处理中暂未超时"
     - AE列 > 0: "超时未解决"

**Excel公式示例** (第2行):
```excel
=IF(AE2="非研发处理","非研发处理",
   IF(ISNUMBER(AE2),
      IF(AD2<>"",
         IF(AE2<=0,"及时解决","未及时解决"),
         IF(AE2<=0,"处理中暂未超时","超时未解决")
      ),
      ""
   )
)
```

## 如何查看公式

### 方法1: 在Excel中查看

1. 打开生成的Excel文件
2. 切换到 "计算解决率过程数据（调整后）" Sheet
3. 点击任意AE列或AO列的单元格
4. 查看编辑栏,会显示完整的公式

### 方法2: 显示所有公式

1. 打开Excel文件
2. 按快捷键 `Ctrl + ~` (或 `Ctrl + Shift + @`)
3. 所有单元格会显示公式而不是计算结果
4. 再次按 `Ctrl + ~` 恢复显示计算结果

### 方法3: 追踪引用单元格

1. 点击公式单元格
2. Excel会自动高亮显示公式引用的单元格
3. 或使用 "公式" → "追踪引用单元格" 功能

## 公式优势

### 1. 透明性
- 完整的计算逻辑对用户可见
- 可以随时核对公式是否正确

### 2. 灵活性
- 修改基础数据后,结果自动更新
- 不需要重新运行程序

### 3. 可审计性
- 保留完整的计算过程
- 便于质量审核和问题排查

### 4. 交互性
- 可以在Excel中测试不同场景
- 修改日期等参数查看结果变化

## 注意事项

### TODAY()函数
AE列公式中使用了`TODAY()`函数来获取当前日期:
- **优势**: 每次打开文件时会自动更新为当天日期
- **注意**: 对于未完成的问题,天数偏差会随时间变化
- **建议**: 定期保存历史数据作为快照

### 公式计算性能
- 791行数据 × 2列 = 1,582个公式
- 打开文件时可能需要几秒钟计算
- 这是正常的,不会影响使用

### 公式编辑
- **不要**直接删除或修改公式单元格
- 如果需要调整数据,请修改引用的原始列(如日期列)
- 公式会自动重新计算

## 验证结果

### 运行日志
```
2026-01-04 13:43:08 | INFO | 开始添加Excel公式到Sheet2...
2026-01-04 13:43:08 | INFO | 列索引映射: {
    '期望解决时间': 15, '计划完成时间': 23,
    '研发解决时间': 30, '更新时间': 39,
    '审批状态': 38, '处理方式': 17,
    '研发交付日期偏差': 31,
    '用于交付日期偏差统计': 41
}
2026-01-04 13:43:08 | INFO | 添加AE列公式到列 AE (索引31)...
2026-01-04 13:43:08 | INFO | 添加AO列公式到列 AO (索引41)...
2026-01-04 13:43:09 | INFO | Excel公式添加完成 ✓
```

### 验证输出
```
AE列(AE2): [Excel公式]
  =IF(Q2<>"研发处理","非研发处理",IF(IF(W2="",O2,W2)="","",IF(AD2="",IF(AL2="已结束",AM2,TODAY()),AD2)-IF(W2="",O2,W2))))

AO列(AO2): [Excel公式]
  =IF(AE2="非研发处理","非研发处理",IF(ISNUMBER(AE2),IF(AD2<>"",IF(AE2<=0,"及时解决","未及时解决"),IF(AE2<=0,"处理中暂未超时","超时未解决")),""))
```

## 技术实现

### 使用的库
- **openpyxl**: 用于操作Excel文件
- **openpyxl.utils.get_column_letter**: 将列索引转换为Excel列字母

### 实现流程
1. 使用pandas写入数据到Excel
2. 使用openpyxl加载已生成的Excel文件
3. 定位AE列和AO列的位置
4. 为每一行数据添加Excel公式
5. 保存文件

### 代码位置
- **文件**: [apps/data_processor/modules/report_generator.py](apps/data_processor/modules/report_generator.py)
- **方法**: `_add_formulas_to_sheet2()`
- **调用**: 在 `generate_report()` 方法中自动调用

## 常见问题

### Q1: 为什么打开文件时显示"循环警告"?
A: 这不是循环引用,而是Excel对复杂公式的警告。可以忽略此警告。

### Q2: 公式可以复制到其他行吗?
A: 可以! Excel会自动调整行号。例如,将AE2的公式复制到AE3,所有引用会自动从"2"变为"3"。

### Q3: 如何禁用自动计算?
A:
1. Excel → 文件 → 选项 → 公式
2. 将"工作簿计算"改为"手动"
3. 需要计算时按F9

### Q4: 公式会占用很多空间吗?
A: 不会。791行的公式文件大小约928KB,与纯数值版本(941KB)相近。

## 相关文档

- [数据处理需求文档](docs/yixianwenti_tuned.md) - 完整的业务逻辑说明
- [数据流转系统说明](DATA_PIPELINE.md) - 完整的数据流程说明
- [项目结构说明](PROJECT_STRUCTURE.md) - 代码组织结构

## 更新日志

### v1.2.0 (2026-01-04)
- ✨ 为AE列添加动态Excel公式
- ✨ 为AO列添加动态Excel公式
- ✅ 支持公式自动计算和更新
- 📝 添加公式说明文档

### v1.1.0 (2026-01-04)
- 之前的版本只保存静态数值,不包含公式
