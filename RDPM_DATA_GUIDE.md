# RDPM数据采集功能说明

## 概述

新增**任务4: RDPM导入数据抽取**功能,从数据库中提取符合RDPM系统格式要求的问题数据,用于导入到RDPM系统进行管理。

## 功能特点

✅ **自动关联** - 通过产品关联表自动获取测试负责人
✅ **标准格式** - 表头完全符合RDPM系统的导入要求
✅ **数据筛选** - 自动过滤终止、审批未通过、需求类等问题
✅ **日期范围** - 与任务3(本周新增问题)使用相同的日期范围(上周)

## 输出文件

### 文件命名
- **格式**: `{YYYY-MM-DD}_RDPM数据.xlsx`
- **示例**: `2026-01-04_RDPM数据.xlsx`
- **位置**: `apps/data_extractor/output/`

### Sheet结构
- **Sheet名称**: `RDPM导入数据`
- **表头**: RDPM系统标准格式(带"(必填)"标记)

## 数据字段

### 字段列表

| 序号 | 字段名 | RDPM字段名 | 类型 | 说明 |
|-----|--------|-----------|------|------|
| 1 | 一线问题提交时间(年-月-日 时：分：秒)(必填) | 创建时间 | TIMESTAMP | 问题创建时间 |
| 2 | 审批编号(必填) | 审批编号 | VARCHAR | 审批编号 |
| 3 | 所涉产品(必填) | 所涉产品 | VARCHAR | 涉及的产品 |
| 4 | 版本(必填) | 软件版本号 | VARCHAR | 软件版本 |
| 5 | 局点(必填) | 所属客户项目 | VARCHAR | 客户项目 |
| 6 | 问题描述(必填) | 问题描述 | TEXT | 问题描述详情 |
| 7 | 测试负责人(必填) | 部门负责人 | VARCHAR | 测试负责人(通过关联获取) |

### 数据来源

- **主表**: `yxwtzb_YYYYMMDD.计算解决率过程数据`
- **关联表**: `public.各产品对应的测试部长`
- **关联条件**: `A.所涉产品 = B.具体的产品`

## 数据筛选规则

### 筛选条件

```sql
WHERE 创建时间 >= '[上周周一] 00:00:01'
  AND 创建时间 <= '[上周周日] 23:59:59'
  AND 审批状态 <> '终止'
  AND 审批结果 <> '审批未通过'
  AND 非研发处理问题类别 <> '需求'
```

### 筛选说明

| 条件 | 说明 | 排除内容 |
|------|------|---------|
| 审批状态 <> '终止' | 排除已终止的问题 | 已终止的流程 |
| 审批结果 <> '审批未通过' | 排除未通过审批的问题 | 审批未通过 |
| 非研发处理问题类别 <> '需求' | 排除需求类问题 | 需求类问题 |

**保留数据**:
- 全部问题(非忽略错误)
- 硬件故障问题也计入RDPM
- 与任务3的区别: 任务3排除"非研发处理"和"硬件故障处理",任务4不排除

## 配置参数

### config.yaml配置

```yaml
# 任务配置
tasks:
  task4_enabled: true  # 是否执行任务4

# 输出配置
output:
  files:
    task4: "RDPM数据.xlsx"
```

### 日期范围

- **起始日期**: 上周周一 00:00:01
- **结束日期**: 上周周日 23:59:59
- **与任务3相同**: 使用相同的日期范围

**示例**:
- 如果今天是 2026-01-04(周日)
- 本周: 2025-12-29 到 2026-01-04
- 上周: 2025-12-22 到 2025-12-28
- 筛选: 2025-12-22 00:00:01 到 2025-12-28 23:59:59

## 使用方法

### 方法1: 运行完整数据抽取

```bash
# 运行所有任务(包括任务4)
./run_extractor.sh
```

### 方法2: 只运行任务4

```bash
# 修改config.yaml,禁用其他任务
tasks:
  task1_enabled: false
  task2_enabled: false
  task3_enabled: false
  task4_enabled: true

# 运行
./run_extractor.sh
```

### 方法3: 使用命令行参数

```bash
cd apps/data_extractor
python3 main.py --start-date 2025-12-22 --end-date 2025-12-28
```

## 输出示例

### 生成日志

```
===============================================================================
开始执行任务4: RDPM数据抽取
===============================================================================
2026-01-04 14:00:36 | INFO | 执行SQL查询...
2026-01-04 14:00:36 | INFO | 查询完成: 返回 8 行数据
2026-01-04 14:00:36 | INFO | 查询到 8 条RDPM数据

任务4完成 ✓
- 输出文件: output/2026-01-04_RDPM数据.xlsx
- 数据行数: 8
- 列数: 7
- 筛选范围: 2025-12-29 至 2025-12-31
- 表头格式: RDPM系统标准
```

### Excel文件示例

| 一线问题提交时间(年-月-日 时：分：秒)(必填) | 审批编号(必填) | 所涉产品(必填) | 版本(必填) | 局点(必填) | 问题描述(必填) | 测试负责人(必填) |
|-------------------------------------------|---------------|---------------|-----------|-----------|---------------|-----------------|
| 2025-12-31 15:13:32 | 202512311513000323388 | 数据库水印 | DWM_V3.1.2_R301... | 808项目 | 因本项目需要... | 胡建慧 |
| 2025-12-30 16:45:33 | 202512301645000339789 | 数据库防火墙 | DBF_V3.1.4_R300 | B10河北机电... | 漏洞名称：CPython... | 胡建慧 |

## 数据验证

### 验证步骤

1. **检查文件生成**
   ```bash
   ls -lh apps/data_extractor/output/*RDPM数据.xlsx
   ```

2. **检查列名**
   - 打开Excel文件
   - 确认表头包含"(必填)"标记
   - 确认列顺序正确

3. **检查数据完整性**
   - 测试负责人列是否已填充
   - 问题描述是否完整
   - 时间格式是否正确

### 常见问题

#### Q1: 测试负责人为空
**原因**: 产品在`public.各产品对应的测试部长`表中不存在
**解决**:
1. 检查产品名称是否完全匹配
2. 在关联表中添加该产品及其测试负责人

#### Q2: 数据行数比预期少
**原因**:
- 部分产品没有关联到测试负责人
- 筛选条件排除了部分数据

**解决**: 检查关联表和筛选条件

#### Q3: 时间格式不正确
**检查**:
- 数据库中时间字段格式
- Excel单元格格式设置
- 确保格式为: `YYYY-MM-DD HH:MM:SS`

## 与其他任务的区别

### 任务3 vs 任务4

| 对比项 | 任务3(本周新增问题) | 任务4(RDPM数据) |
|--------|-------------------|----------------|
| 日期范围 | 上周一到上周日 | 上周一到上周日(相同) |
| 处理方式 | 排除"非研发处理"和"硬件故障处理" | 不排除 |
| 字段数 | 18个字段 | 7个字段 |
| 表头格式 | 自定义格式 | RDPM标准格式 |
| 关联表 | 无 | 关联测试负责人表 |
| 用途 | 内部统计分析 | 导入RDPM系统 |

### 数据量对比

**示例数据** (2025-12-29至2025-12-31):
- 任务3: 5条(本周新增问题)
- 任务4: 8条(RDPM导入数据)

**差异原因**: 任务4包含硬件故障处理问题,而任务3排除

## 技术实现

### 代码位置

- **主程序**: [apps/data_extractor/main.py](apps/data_extractor/main.py)
- **抽取器**: [apps/data_extractor/modules/extractor.py](apps/data_extractor/modules/extractor.py) - `task4_extract_rdpm_data()`
- **配置文件**: [apps/data_extractor/config.yaml](apps/data_extractor/config.yaml)

### SQL查询

```python
query = """
SELECT
    A.创建时间,
    A.审批编号,
    A.所涉产品,
    A.软件版本号,
    A.所属客户项目,
    A.问题描述,
    B.部门负责人 as "测试负责人"
FROM yxwtzb_YYYYMMDD.计算解决率过程数据 A,
     public."各产品对应的测试部长" B
WHERE 1=1
  AND A.所涉产品=B."具体的产品"
  AND A.创建时间 >= %(start_date)s 00:00:01
  AND A.创建时间 <= %(end_date)s 23:59:59
  AND A.审批状态 <> '终止'
  AND A.审批结果 <> '审批未通过'
  AND A.非研发处理问题类别 <> '需求'
ORDER BY A.创建时间 DESC;
"""
```

### 列名重命名

```python
rdpm_columns = {
    '创建时间': '一线问题提交时间(年-月-日 时：分：秒)(必填)',
    '审批编号': '审批编号(必填)',
    '所涉产品': '所涉产品(必填)',
    '软件版本号': '版本(必填)',
    '所属客户项目': '局点(必填)',
    '问题描述': '问题描述(必填)',
    '测试负责人': '测试负责人(必填)'
}
```

## 更新日志

### v1.3.0 (2026-01-04)
- ✨ 新增任务4: RDPM导入数据抽取
- ✅ 支持产品关联获取测试负责人
- ✅ 表头格式符合RDPM系统标准
- ✅ 自动筛选和过滤数据
- 📝 完善需求文档和使用说明

## 后续优化

1. **数据验证增强** - 添加必填字段检查
2. **错误报告** - 缺失测试负责人的产品列表
3. **配置灵活性** - 支持自定义关联表和字段
4. **数据统计** - 各产品的RDPM导入数据统计

## 相关文档

- [数据抽取需求文档.md](doc/数据抽取需求文档.md) - 完整需求说明
- [apps/data_extractor/config.yaml](apps/data_extractor/config.yaml) - 配置文件
- [DATA_PIPELINE.md](DATA_PIPELINE.md) - 数据流转说明
