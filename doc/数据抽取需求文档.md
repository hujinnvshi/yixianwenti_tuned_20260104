# 数据自动抽取功能需求文档

## 一、功能概述

从PostgreSQL数据库中抽取数据并生成4个Excel文件,用于一线问题跟踪管理和RDPM系统导入。

## 二、数据库连接信息

### 2.1 连接参数

```
主机: 172.16.215.119
端口: 5432
数据库: postgres
用户名: admin
密码: admin
```

### 2.2 连接字符串

```
postgresql://admin:admin@172.16.215.119:5432/postgres
```

## 三、数据表结构

### 3.1 日期相关说明

**Schema命名规则**: `yxwtzb_YYYYMMDD`
- `YYYYMMDD`: 表示本周周一的日期
- 例如: `yxwtzb_20251229` 表示2025年12月29日(周一)对应的schema
- **默认**: 使用当前周周一的日期
- **特殊情况**: 可以手动指定日期

### 3.2 源表说明

#### 表1: 导出原始数据
- **完整表名**: `yxwtzb_YYYYMMDD.导出原始数据`
- **说明**: 原始的一线问题数据
- **用途**: 生成 `原始数据.xlsx`

#### 表2: 计算解决率过程数据
- **完整表名**: `yxwtzb_YYYYMMDD.计算解决率过程数据`
- **说明**: 经过清洗和计算后的数据
- **用途**: 生成 `计算数据.xlsx` 和 `本周新增问题.xlsx`

## 四、数据抽取任务

### 任务1: 原始数据抽取

#### 4.1.1 输出文件
- **文件名**: `原始数据.xlsx`
- **Sheet名称**: `原始数据`

#### 4.1.2 SQL查询
```sql
SELECT *
FROM yxwtzb_YYYYMMDD.导出原始数据
ORDER BY 创建时间 DESC;
```

#### 4.1.3 说明
- 直接导出全部数据
- 按 `创建时间` 降序排列

---

### 任务2: 计算数据抽取

#### 4.2.1 输出文件
- **文件名**: `计算数据.xlsx`
- **Sheet名称**: `计算解决率过程数据`

#### 4.2.2 SQL查询
```sql
SELECT *
FROM yxwtzb_YYYYMMDD.计算解决率过程数据
ORDER BY 创建时间 DESC;
```

#### 4.2.3 说明
- 直接导出全部数据
- 按 `创建时间` 降序排列

---

### 任务3: 本周新增问题抽取

#### 4.3.1 输出文件
- **文件名**: `本周新增问题.xlsx`
- **Sheet名称**: `本周新增问题`

#### 4.3.2 目标表结构

| 序号 | 字段名 | 类型 | 说明 | 示例值 |
|-----|--------|------|------|--------|
| 1 | 序号 | INTEGER | 序号 | 1, 2, 3... |
| 2 | 所属客户项目 | VARCHAR(255) | 客户项目名称 | 八马茶业 |
| 3 | 项目类型 | VARCHAR(255) | 项目类型 | 商用交付 |
| 4 | 所涉产品 | VARCHAR(255) | 涉及的产品 | 数据库防火墙 |
| 5 | 软件版本号 | VARCHAR(255) | 软件版本 | DBF_V3.1.4_R300 |
| 6 | 紧急程度 | VARCHAR(255) | 紧急程度 | 二级(紧急) |
| 7 | 问题描述 | TEXT | 问题描述详情 | 生产系统存在... |
| 8 | 原因分析及解决方案 | TEXT | **固定文本** | '问题原因：xxx 解决方案：xxx (自行修改)' |
| 9 | 问题处理类别 | VARCHAR(255) | 处理方式 | 研发处理 |
| 10 | 期望解决时间 | VARCHAR(255) | 期望解决时间 | 2026-01-06 |
| 11 | 计划解决时间(系统导出) | VARCHAR(255) | 计划完成时间 | 2026-01-08 |
| 12 | 计划解决时间(最新计划) | VARCHAR(255) | **空值** | '' |
| 13 | 当前负责人 | VARCHAR(255) | 当前负责人 | 张三 |
| 14 | 研发负责人 | VARCHAR(255) | 研发负责人 | 李四 |
| 15 | 状态(以系统导出计算) | VARCHAR(255) | 用于交付日期偏差统计 | 及时解决 |

**重要说明**:
- 第8字段"原因分析及解决方案"使用**固定文本**,不是从数据库读取
- 第12字段"计划解决时间(最新计划)"固定为**空值**
- 已删除"数据id"、"审批状态"、"创建时间"三列
- **序号列重新编号**: 导出时序号列从1开始连续编号(1, 2, 3...),不使用原始数据的序号

#### 4.3.3 字段映射关系

| 目标字段 | 源字段 | 转换规则 |
|---------|--------|----------|
| 序号 | 序号 | 直接映射 |
| 所属客户项目 | 所属客户项目 | 直接映射 |
| 项目类型 | 项目类型 | 直接映射 |
| 所涉产品 | 所涉产品 | 直接映射 |
| 软件版本号 | 软件版本号 | 直接映射 |
| 紧急程度 | 紧急程度 | 直接映射 |
| 问题描述 | 问题描述 | 直接映射 |
| **原因分析及解决方案** | - | **固定值: '问题原因：xxx 解决方案：xxx (自行修改)'** |
| 问题处理类别 | 处理方式 | 直接映射 |
| 期望解决时间 | 期望解决时间 | 直接映射 |
| 计划解决时间(系统导出) | 计划完成时间 | 直接映射 |
| **计划解决时间(最新计划)** | - | **固定值: 空字符串** |
| 当前负责人 | 当前负责人 | 直接映射 |
| 研发负责人 | 研发负责人 | 直接映射 |
| 状态(以系统导出计算) | 用于交付日期偏差统计 | 直接映射 |

#### 4.3.4 数据筛选条件

```sql
WHERE 创建时间 >= '[起始日期] 00:00:01'
  AND 创建时间 <= '[结束日期] 23:59:59'
  AND 审批状态 <> '终止'
  AND 处理方式 NOT IN ('非研发处理', '硬件故障处理')
  AND 审批结果 <> '审批未通过'
ORDER BY 创建时间 DESC;
```

**筛选条件说明**:

| 条件 | 说明 | 值 |
|------|------|-----|
| 创建时间 >= | 起始日期(包含) | 上周周一 00:00:01 |
| 创建时间 <= | 结束日期(包含) | 上周周日 23:59:59 |
| 审批状态 <> | 排除已终止的问题 | '终止' |
| 处理方式 NOT IN | 只统计研发处理的问题 | '非研发处理', '硬件故障处理' |
| 审批结果 <> | 排除未通过审批的问题 | '审批未通过' |

---

### 任务4: RDPM导入数据抽取

#### 4.4.1 输出文件
- **文件名**: `{日期}_RDPM数据.xlsx`
- **日期格式**: YYYYMMDD(当前日期)
- **示例**: `20260104_RDPM数据.xlsx`
- **Sheet名称**: `RDPM导入数据`

#### 4.4.2 目标表结构(RDPM系统要求)

| 序号 | 字段名 | RDPM字段名 | 类型 | 说明 | 示例值 |
|-----|--------|-----------|------|------|--------|
| 1 | 创建时间 | 一线问题提交时间(年-月-日 时：分：秒)(必填) | TIMESTAMP | 问题创建时间 | 2025-12-22 09:40:48 |
| 2 | 审批编号 | 审批编号(必填) | VARCHAR(255) | 审批编号 | YXWT-2025-12-22-001 |
| 3 | 所涉产品 | 所涉产品(必填) | VARCHAR(255) | 涉及的产品 | 数据库防火墙 |
| 4 | 软件版本号 | 版本(必填) | VARCHAR(255) | 软件版本 | DBF_V3.1.4_R300 |
| 5 | 所属客户项目 | 局点(必填) | VARCHAR(255) | 客户项目 | 八马茶业 |
| 6 | 问题描述 | 问题描述(必填) | TEXT | 问题描述详情 | 生产系统存在... |
| 7 | 测试负责人 | 测试负责人(必填) | VARCHAR(255) | 测试负责人 | 张三 |

**重要说明**:
- 表头必须完全匹配RDPM系统的要求,包含"(必填)"标记
- 字段顺序必须严格按照上述顺序
- 测试负责人通过关联`public.各产品对应的测试部长`表获取

#### 4.4.3 SQL查询

```sql
SELECT
    A.创建时间,
    A.审批编号,
    A.所涉产品,
    A.软件版本号,
    A.所属客户项目,
    A.问题描述,
    B.部门负责人 as "测试负责人"
FROM yxwtzb_20251229.计算解决率过程数据 A,
     public."各产品对应的测试部长" B
WHERE 1=1
  AND A.所涉产品=B."具体的产品"
  AND A.创建时间 >= '2025-12-22 00:00:01'
  AND A.创建时间 <= '2025-12-28 23:59:59'
  AND A.审批状态 <> '终止'
  AND A.审批结果 <> '审批未通过'
  AND A.非研发处理问题类别 <> '需求'
ORDER BY A.创建时间 DESC;
```

#### 4.4.4 数据筛选条件

| 条件 | 说明 | 值 |
|------|------|-----|
| 创建时间 >= | 起始日期(包含) | 上周周一 00:00:01 |
| 创建时间 <= | 结束日期(包含) | 上周周日 23:59:59 |
| 审批状态 <> | 排除已终止的问题 | '终止' |
| 审批结果 <> | 排除未通过审批的问题 | '审批未通过' |
| 非研发处理问题类别 <> | 排除需求类问题 | '需求' |
| 产品关联 | 通过产品关联获取测试负责人 | A.所涉产品 = B.具体的产品 |

#### 4.4.5 日期范围说明

**默认规则**:
- **起始日期**: 上周周一
- **结束日期**: 上周周日
- 与任务3(本周新增问题)使用相同的日期范围

**示例**:
- 如果今天是 2026-01-04(周日)
- 则本周是: 2025-12-29(周一) 到 2026-01-04(周日)
- 上周是: 2025-12-22(周一) 到 2025-12-28(周日)
- 筛选范围: `2025-12-22 00:00:01` 到 `2025-12-28 23:59:59`

#### 4.4.6 列名映射

为了符合RDPM系统的要求,查询结果需要重命名列:

| 数据库字段名 | RDPM表头名 |
|-------------|-----------|
| 创建时间 | 一线问题提交时间(年-月-日 时：分：秒)(必填) |
| 审批编号 | 审批编号(必填) |
| 所涉产品 | 所涉产品(必填) |
| 软件版本号 | 版本(必填) |
| 所属客户项目 | 局点(必填) |
| 问题描述 | 问题描述(必填) |
| 部门负责人 | 测试负责人(必填) |

**手动调整**:
- 可以通过配置文件或命令行参数指定日期范围
- 格式: `YYYY-MM-DD`

## 五、配置参数

### 5.1 日期配置

| 参数名 | 说明 | 默认值 | 可选 |
|--------|------|--------|------|
| schema_date | Schema日期(本周周一) | 自动计算 | 是 |
| start_date | 筛选起始日期(上周周一) | 自动计算 | 是 |
| end_date | 筛选结束日期(上周周日) | 自动计算 | 是 |

### 5.2 输出配置

| 参数名 | 说明 | 默认值 |
|--------|------|--------|
| output_dir | 输出目录 | `output/` |
| filename_1 | 任务1输出文件名 | `原始数据.xlsx` |
| filename_2 | 任务2输出文件名 | `计算数据.xlsx` |
| filename_3 | 任务3输出文件名 | `本周新增问题.xlsx` |
| filename_4 | 任务4输出文件名 | `{YYYYMMDD}_RDPM数据.xlsx` |

## 六、输出规范

### 6.1 文件命名规则

**格式**: `{任务名称}.xlsx`

**示例**:
- `原始数据.xlsx`
- `计算数据.xlsx`
- `本周新增问题.xlsx`
- `20260104_RDPM数据.xlsx` (任务4,带日期前缀)

### 6.2 文件结构

每个Excel文件包含:
- 1个Sheet(数据内容)
- 第一行为表头
- 数据从第二行开始

### 6.3 数据格式

- 日期字段: 保持原格式
- 数字字段: 保持原格式
- 文本字段: 保持原格式
- 空值: 显示为空白单元格

## 七、错误处理

### 7.1 数据库连接失败
- **行为**: 记录错误日志,退出程序
- **日志内容**: 连接参数、错误原因

### 7.2 表不存在
- **行为**: 记录错误日志,跳过该任务
- **日志内容**: 表名、错误原因

### 7.3 数据为空
- **行为**: 生成空Excel文件(仅含表头)
- **日志内容**: 警告信息

### 7.4 字段缺失
- **行为**: 使用NULL值填充,继续执行
- **日志内容**: 表名、缺失字段名

## 八、日志记录

### 8.1 日志级别

- INFO: 正常流程信息
- WARNING: 警告信息(数据为空、字段缺失等)
- ERROR: 错误信息(连接失败、表不存在等)

### 8.2 日志内容

每个任务必须记录:
- 任务开始时间
- 数据库连接信息
- SQL查询语句
- 查询结果行数
- 文件输出路径
- 任务结束时间
- 执行耗时

## 九、使用方式

### 9.1 命令行方式

```bash
# 使用默认日期(本周周一和上周范围)
python data_extractor.py

# 指定schema日期
python data_extractor.py --schema-date 20251229

# 指定筛选日期范围
python data_extractor.py --start-date 2025-12-22 --end-date 2025-12-28

# 指定输出目录
python data_extractor.py --output-dir output/
```

### 9.2 配置文件方式

```bash
# 使用配置文件
python data_extractor.py --config config/data_extractor.yaml
```

## 十、注意事项

1. **日期格式**: 统一使用 `YYYY-MM-DD` 格式
2. **Schema日期**: 一般使用本周周一,特殊情况可手动修改
3. **筛选日期**: 默认为上周一周,特殊情况可手动修改
4. **固定字段**: "原因分析及解决方案"和"计划解决时间(最新计划)"需要特殊处理
5. **数据库大小写**: PostgreSQL表名和字段名区分大小写,注意使用双引号
6. **编码问题**: 导出Excel时注意中文编码,建议使用UTF-8

## 十一、后续优化方向

1. 支持配置文件管理
2. 支持定时任务自动执行
3. 支持邮件发送功能
4. 支持数据统计和可视化
5. 支持增量更新(只导出新增数据)
