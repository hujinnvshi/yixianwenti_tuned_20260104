# 数据流转系统使用说明

## 概述

本系统实现了从数据库到最终分析的完整数据流转流程:

```
数据库 → 数据抽取 → 数据流转 → 数据分析 → 最终报告
```

## 完整流程

### 步骤1: 数据抽取

从PostgreSQL数据库中抽取数据并生成Excel文件。

**运行方式:**
```bash
./run_extractor.sh
```

**输出位置:** `apps/data_extractor/output/`

**生成文件:**
- `2026-01-04_原始数据.xlsx` - 原始数据
- `2026-01-04_计算数据.xlsx` - 计算数据
- `2026-01-04_本周新增问题.xlsx` - 本周新增问题

**数据源:**
- 数据库: 172.16.215.119:5432
- Schema: `yxwtzb_20251229` (本周周一)
- 筛选日期: 2025-12-29 至 2025-12-31 (上周)

### 步骤2: 数据流转

将数据抽取模块生成的最新数据拷贝到数据处理模块的data目录。

**运行方式:**
```bash
python3 transfer_data.py
```

**功能:**
1. 清空 `data/` 目录中的旧Excel文件
2. 查找最新的抽取文件 (按修改时间排序)
3. 拷贝并重命名文件:
   - `*_原始数据.xlsx` → `data/原始.xlsx`
   - `*_计算数据.xlsx` → `data/计算.xlsx`

**日志位置:** `logs/data_transfer_*.log`

### 步骤3: 数据分析

对流转过来的数据进行分析计算,生成最终报告。

**运行方式:**
```bash
./run_processor.sh
```

**输入数据:**
- `data/计算.xlsx` - Sheet: 计算解决率过程数据
- `data/原始.xlsx` - Sheet: 原始数据

**输出位置:** `output/`

**生成文件:**
- `第52周一线问题跟踪确认-20260104.xlsx` - 最终分析报告

**报告内容:**
1. Sheet1: `2025122911704000480` - 原始数据备份
2. Sheet2: `计算解决率过程数据(调整后)` - 处理后的完整数据
3. Sheet3: `计算解决率` - 透视表汇总

**计算内容:**
- AE列: 研发交付日期偏差
- AO列: 用于交付日期偏差统计
- 解决率: (及时解决 + 未及时解决) / (总计 - 非研发处理) × 100%
- 及时解决率: 及时解决 / (总计 - 非研发处理) × 100%

## 快速运行

### 方式1: 手动分步执行

```bash
# 1. 数据抽取
./run_extractor.sh

# 2. 数据流转
python3 transfer_data.py

# 3. 数据分析
./run_processor.sh
```

### 方式2: 一键执行 (推荐)

创建一键执行脚本 `run_full_pipeline.sh`:

```bash
#!/bin/bash
set -e  # 遇到错误立即退出

echo "================================"
echo "完整数据流转流程"
echo "================================"
echo ""

# 激活虚拟环境
source venv/bin/activate

# 步骤1: 数据抽取
echo "步骤1: 数据抽取..."
./run_extractor.sh

# 步骤2: 数据流转
echo ""
echo "步骤2: 数据流转..."
python3 transfer_data.py

# 步骤3: 数据分析
echo ""
echo "步骤3: 数据分析..."
./run_processor.sh

echo ""
echo "================================"
echo "完整流程执行成功!"
echo "================================"
```

## 配置文件

### 数据抽取配置
**文件:** `apps/data_extractor/config.yaml`

```yaml
database:
  host: "172.16.215.119"
  port: 5432
  database: "postgres"
  user: "admin"
  password: "admin"

schema:
  date: null  # null表示自动计算本周周一

date_range:
  start_date: "2025-12-29"  # 上周周一
  end_date: "2025-12-31"    # 上周周日

output:
  directory: "output"
  date_prefix: true  # 添加日期前缀
  files:
    task1: "原始数据.xlsx"
    task2: "计算数据.xlsx"
    task3: "本周新增问题.xlsx"
```

### 数据处理配置
**文件:** `apps/data_processor/config.yaml`

```yaml
input:
  table1: "../../data/计算.xlsx"
  table2: "../../data/原始.xlsx"
  sheet_name1: "计算解决率过程数据"
  sheet_name2: "原始数据"

output:
  directory: "../../output"
  filename: "第52周一线问题跟踪确认-20260104.xlsx"
```

## 输出文件说明

### 数据抽取阶段

| 文件名 | 位置 | 大小 | 说明 |
|--------|------|------|------|
| `2026-01-04_原始数据.xlsx` | `apps/data_extractor/output/` | ~435KB | 原始数据791行 |
| `2026-01-04_计算数据.xlsx` | `apps/data_extractor/output/` | ~316KB | 计算数据791行 |
| `2026-01-04_本周新增问题.xlsx` | `apps/data_extractor/output/` | ~7KB | 新增问题5行 |

### 数据流转阶段

| 文件名 | 位置 | 大小 | 说明 |
|--------|------|------|------|
| `原始.xlsx` | `data/` | ~435KB | 从原始数据拷贝 |
| `计算.xlsx` | `data/` | ~316KB | 从计算数据拷贝 |

### 数据分析阶段

| 文件名 | 位置 | 大小 | 说明 |
|--------|------|------|------|
| `第52周一线问题跟踪确认-20260104.xlsx` | `output/` | ~941KB | 最终分析报告 |

## 日志文件

所有日志保存在 `logs/` 目录:

- `data_extractor_*.log` - 数据抽取日志
- `data_transfer_*.log` - 数据流转日志
- `data_processing_*.log` - 数据处理日志

## 统计数据

**最新运行结果 (2026-01-04):**

- 数据抽取: 791行原始数据, 791行计算数据, 5行新增问题
- 数据清洗: 保留666行 (84.20%), 剔除125行
- 产品数量: 20个
- 平均及时解决率: 88.16%
- 最高及时解决率: 100.00%
- 最低及时解决率: 50.00%
- 处理时间: ~2秒

## 故障排查

### 问题1: 找不到抽取文件

**症状:** `未找到匹配的文件: *_原始数据.xlsx`

**解决:** 先运行数据抽取程序: `./run_extractor.sh`

### 问题2: Sheet名称不匹配

**症状:** `Worksheet named 'Result 1' not found`

**解决:** 检查配置文件中的sheet_name配置是否正确:
- 计算数据: `计算解决率过程数据`
- 原始数据: `原始数据`

### 问题3: 数据库连接失败

**症状:** `connection to server at "172.16.215.119", port 5432 failed`

**解决:**
1. 检查网络连接
2. 确认数据库服务运行正常
3. 验证配置文件中的连接参数

## 维护建议

1. **定期清理:**
   - 删除旧的日志文件 (保留7天)
   - 清理不再需要的Excel文件

2. **配置更新:**
   - 每周更新日期范围配置
   - 根据需要调整输出文件名

3. **数据备份:**
   - 定期备份 `output/` 目录
   - 保留重要的历史报告

## 更新日志

### v1.1.0 (2026-01-04)
- ✨ 实现数据流转脚本 `transfer_data.py`
- ✨ 添加日期前缀功能
- ✨ 支持自动文件重命名
- ✨ 完善日志记录
- ✅ 修复sheet名称配置问题
- ✅ 修复相对路径配置

### v1.0.0 (初始版本)
- ✅ 数据抽取功能
- ✅ 数据分析功能
- ✅ 报表生成功能
